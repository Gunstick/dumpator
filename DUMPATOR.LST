ALERT 1,"Dumpator by Gunstick/ULM 2024",1," Run ",a%
' 129
PRINT "Enter disk drive to image:"
FORM INPUT 1,a$
drive%=ASC(a$)-ASC("A")
PRINT "imaging ";a$;"(";drive%;"):"
IF drive%<2 OR drive%>15
  ALERT 3,"give harddisk letter C-P",1," OK ",a%
  exit
ENDIF
' get info about disk with getbpb
bpb=BIOS(7,W:drive%)
' word recsiz /* bytes per sectir */
' word clsiz /* sectors per cluster */
' word clsizb /* bytes per cluster */
' word rdlen
' word fsiz
' word fatrec
' word datrec
' word numcl /* number of clusters */
' word bflags
recsiz%=DPEEK(bpb%)
clustsiz%=DPEEK(bpb%+2)
clustsizb%=DPEEK(bpb%+4)
numcl%=DPEEK(bpb%+14)
PRINT "   bytes per sector: ";recsiz%
PRINT "sectors per cluster: ";clustsiz%
PRINT "  bytes per cluster: ";clustsizb%
PRINT " number of clusters: ";numcl%
dest$=a$+"_dump.img"
FILESELECT #"Destination file","",dest$,dest$
PRINT dest$
OPEN "O",#4,dest$
diskdata$=SPACE$(512)
FOR sector%=0 TO 65535
  PRINT "Reading ";+sector%
  result=BIOS(4,0,VARPTR(diskdata$),1,W:sector%,W:drive%)
  IF result<>0
    PRINT "Error on sector ";+sector%
  ENDIF
  ' on error write previous data
  WRITE #4,diskdata$
NEXT sector
CLOSE #4
